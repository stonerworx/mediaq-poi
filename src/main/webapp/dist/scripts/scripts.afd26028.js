!function(){"use strict";function a(a,b,c){a.when("/",{templateUrl:"views/main.html",controller:"MainController",controllerAs:"vm"}).when("/about",{templateUrl:"views/about.html",controller:"AboutController",controllerAs:"vm"}).otherwise({redirectTo:"/"}),b.configure({key:"AIzaSyDIZgzM1EkYHEhOJfcjUvm0ovOUczk7v8s",v:"3.17"}),c.debugEnabled(!0)}a.$inject=["$routeProvider","uiGmapGoogleMapApiProvider","$logProvider"],angular.module("mediaqPoi",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","uiGmapgoogle-maps","Showdown"]).config(a)}(),function(){"use strict";function a(a,b,c,d,e){var f=this,g=3e3,h=[],i=!1;a.then(function(a){f.loading=!0;var j=new a.Map(angular.element(".angular-google-map-container")[0]),k=angular.element(".videoplayer video")[0],l=new a.places.Autocomplete(angular.element("#placesearch")[0]);f.map={control:{},center:{latitude:48.150529,longitude:11.595077},dragging:!1,zoom:15},f.options={mapTypeControl:!1,zoomControl:!0,zoomControlOptions:{style:a.ZoomControlStyle.LARGE,position:a.ControlPosition.LEFT_CENTER},panControl:!1,streetViewControl:!1,mapTypeId:a.MapTypeId.ROADMAP,heading:180,tilt:45},f.markers=h,f.videoVisible=!1,f.poiVisible=!1,f.nearbyPoiMarkers=[],f.visiblePoiMarkers=[],f.markerOptions={animation:a.Animation.DROP},f.activeVideo=new c,f.loading=!1,f.videoPositionMarker={id:"videoPosition",icon:{url:"/images/ignore/position.png",anchor:{x:12.5,y:12.5}},coords:{},control:{}},f.videoPositionView={id:"videoView",icon:{path:"M 0 0 L -35 -100 L 35 -100 z",fillColor:"#3884ff",fillOpacity:.7,scale:1,strokeColor:"#356cde",rotation:90,strokeWeight:1}},f.currentPoiMarkers=[],f.searchRadius={},f.places={autocomplete:"",options:null,results:"",details:""},k.addEventListener("timeupdate",function(){var a=Math.round(k.currentTime);if(f.activeVideo.setSecond(a),f.activeVideo.getVisible()){var b=f.activeVideo.getCurrentCoordinates();null!==b.latitude&&null!==b.longitude&&(f.videoPositionMarker.coords=b,f.videoPositionView.icon.rotation=f.activeVideo.getCurrentRotation(),f.map.center=f.videoPositionMarker.coords,f.currentPoiMarkers=f.activeVideo.getCurrentPoiMarkers());for(var c in f.currentPoiMarkers)f.currentPoiMarkers[c].show=!0}else f.videoPositionMarker={},f.currentPoiMarkers=[];d.$apply()},!1),f.clickMarker=function(a){f.openVideo(a.model.id)},f.closeVideo=function(){k.pause(),f.activeVideo.hide(),f.markers=h,f.activeVideo=new c,f.nearbyPoiMarkers=[],f.visiblePoiMarkers=[],i&&f.visiblePoiMarkers.push(i),f.videoPositionMarker.coords={},f.videoVisible=!1,f.currentPoiMarkers=[],f.map.zoom=15},f.openVideo=function(a){f.loading=!0,h=f.markers,i=f.poiVisible?f.visiblePoiMarkers[0]:!1,f.markers=[],b.getVideo(a).then(function(a){f.activeVideo=a,f.map.center=f.activeVideo.getCenter(),f.map.zoom=f.activeVideo.getZoomLevel(),f.videoVisible=!0,f.searchRadius.center=f.activeVideo.getCenter();var b=function(a){f.searchRadius.radius=a,a<f.activeVideo.getRadius()?e(function(){b(f.searchRadius.radius+2)},5):e(function(){f.nearbyPoiMarkers=f.activeVideo.getNearbyPoiMarkers(),e(function(){f.nearbyPoiMarkers=[],f.visiblePoiMarkers=f.activeVideo.getVisiblePoiMarkers();for(var a in f.visiblePoiMarkers)f.visiblePoiMarkers[a].show=!0;e(function(){f.searchRadius={center:{latitude:0,longitude:0},radius:0},f.visiblePoiMarkers=[],f.activeVideo.show(),k.play(),f.loading=!1},g)},2/3*g)},1/3*g)};b(1)})},a.event.addListenerOnce(j,"idle",function(){function c(){clearTimeout(g),f.videoVisible||f.poiVisible||(g=setTimeout(h,3e3))}var e=f.map.control.getGMap();navigator.geolocation.getCurrentPosition(function(a){f.map.center.latitude=a.coords.latitude,f.map.center.longitude=a.coords.longitude,d.$apply(),h()},function(){h()});var g,h=function(){f.loading=!0,angular.element(".loading").focus();var a={northEast:{latitude:e.getBounds().getNorthEast().lat(),longitude:e.getBounds().getNorthEast().lng()},southWest:{latitude:e.getBounds().getSouthWest().lat(),longitude:e.getBounds().getSouthWest().lng()}};b.getVideos(a).then(function(a){f.loading=!1,f.markers=[],angular.forEach(a,function(a){f.markers.push(a.getMarker())})})};a.event.addListener(e,"dragstart",function(){clearTimeout(g)}),a.event.addListener(e,"dragend",c),a.event.addListener(e,"zoom_changed",c),a.event.addListener(l,"place_changed",function(){f.visiblePoiMarkers=[],f.poiVisible=!1;var a=l.getPlace();a.geometry&&(f.poiVisible=!0,f.markers=[],f.map.center.latitude=a.geometry.location.lat(),f.map.center.longitude=a.geometry.location.lng(),f.map.zoom=15,d.$apply(),f.loading=!0,b.getPoi(a.place_id).then(function(a){f.visiblePoiMarkers.push(a.getMarker()),f.visiblePoiMarkers[0].show=!0,f.visiblePoiMarkers[0].close=function(){f.visiblePoiMarkers=[],f.poiVisible=!1,f.poiSearch="",i=!1,h()},f.markers=a.getVideoMarkers(),f.loading=!1}))})})})}angular.module("mediaqPoi").controller("MainController",["uiGmapGoogleMapApi","dataService","VideoModel","$scope","$timeout",a])}(),function(){"use strict";function a(a,b){var c=this;a.get("views/readme.md").then(function(a){c.markdown=b.makeHtml(a.data)})}angular.module("mediaqPoi").controller("AboutController",["$http","$Showdown",a])}(),function(){"use strict";function a(a,b,c,d,e){function f(e){var f=c.defer();b.info("requesting videos with bounds: NW {"+e.northEast.latitude+", "+e.northEast.longitude+"}. SE {"+e.southWest.latitude+", "+e.southWest.longitude+"}");var g=i+"/videos?action=range_query&bound1_lat="+e.northEast.latitude+"&bound1_lng="+e.northEast.longitude+"&bound2_lat="+e.southWest.latitude+"&bound2_lng="+e.southWest.longitude;return b.debug(g),a(g).get(function(a){void 0!==a.videos?b.info("videos received ("+a.videos.length+"). returning."):b.error("failed to load videos.");var c=[];angular.forEach(a.videos,function(a){c.push(new d(a))}),f.resolve(c)}),f.promise}function g(f){var g=c.defer();b.info("requesting video "+f+".");var h=i+"/video/"+f;return b.debug(h),a(h).get(function(a){b.info("video received. returning.");var c=new d(a.video);c.setCenter(a.center),c.setRadius(a.searchRange);var f=[];angular.forEach(a.nearbyPois,function(a){f.push(new e(a))}),c.setNearbyPois(f);var h=[];angular.forEach(a.visiblePois,function(a){h.push(new e(a))}),c.setVisiblePois(h);var i=[];angular.forEach(a.timeline,function(a,b){var c=[];angular.forEach(a,function(a){c.push(new e(a))}),i[b]=c}),c.setTimeline(i),c.setPosTimeline(a.posTimeline),g.resolve(c)}),g.promise}function h(f){var g=c.defer();b.info("requesting poi "+f+".");var h=i+"/poi/"+f;return b.debug(h),a(h).get(function(a){b.info("poi received. returning.");var c=new e(a.poi),f=[];angular.forEach(a.videos,function(a){f.push(new d(a))}),c.setVideos(f),g.resolve(c)}),g.promise}var i="";return"localhost:9000"===window.location.host&&(i="http://localhost:8888"),{getVideos:f,getVideo:g,getPoi:h}}angular.module("mediaqPoi").factory("dataService",["$resource","$log","$q","VideoModel","PoiModel",a])}(),function(){"use strict";function a(a){function b(b){var c,d=!1,e=!1,f=0,g=0,h={},i=0,j=[],k=[],l=[],m={},n={},o=0;void 0!==b&&(d=b.id,c=b.filePath,f=b.latitude,g=b.longitude);var p=function(a){var b=[];return angular.forEach(a,function(a){b.push(a.getMarker())}),b};this.getId=function(){return d},this.show=function(){e=!0},this.hide=function(){e=!1},this.getVisible=function(){return e},this.getSrc=function(){return d?a.trustAsResourceUrl(c):""},this.getLatitude=function(){return f},this.getLongitude=function(){return g},this.getMarker=function(){return{id:this.getId(),latitude:this.getLatitude(),longitude:this.getLongitude(),icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"}},this.getPath=function(){return j},this.setCenter=function(a){h=a},this.setRadius=function(a){i=a},this.setNearbyPois=function(a){k=a},this.setVisiblePois=function(a){l=a},this.setTimeline=function(a){m=a},this.setPosTimeline=function(a){angular.forEach(a,function(a){j.push({latitude:a.latitude,longitude:a.longitude})}),n=a},this.getCenter=function(){return h},this.getRadius=function(){return i},this.getZoomLevel=function(){return 17},this.getNearbyPois=function(){return k},this.getVisiblePois=function(){return l},this.getTimeline=function(){return m},this.getNearbyPoiMarkers=function(){return p(k)},this.getVisiblePoiMarkers=function(){return p(l)},this.setSecond=function(a){o=parseInt(a)},this.getSecond=function(){return o},this.getCurrentPois=function(){return m[this.getSecond()]},this.getCurrentPoiMarkers=function(){return p(this.getCurrentPois())},this.getCurrentCoordinates=function(){var a=n[this.getSecond()],b=null,c=null;return void 0!==a&&(b=a.latitude,c=a.longitude),{latitude:b,longitude:c}},this.getCurrentRotation=function(){var a=n[this.getSecond()];return void 0!==a?a.thetaX:90}}return b}angular.module("mediaqPoi").factory("VideoModel",["$sce",a])}(),function(){"use strict";function a(){function a(a){var b=a.id,c=a.name,d=a.latitude,e=a.longitude,f=[];this.getId=function(){return b},this.getName=function(){return c},this.getLatitude=function(){return d},this.getLongitude=function(){return e},this.getMarker=function(){return{id:this.getId(),icon:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png",latitude:this.getLatitude(),longitude:this.getLongitude(),options:{title:this.getName()}}},this.setVideos=function(a){f=a},this.getVideos=function(){return f},this.getVideoMarkers=function(){var a=[];return angular.forEach(f,function(b){a.push(b.getMarker())}),a}}return a}angular.module("mediaqPoi").factory("PoiModel",[a])}();